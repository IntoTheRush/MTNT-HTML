<!DOCTYPE html>
<html>
<head>
  <title>Record Store Collection</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
    }

    .badge-grid {
      display: grid;
      grid-template-columns: repeat(5, 250px);
      grid-gap: 20px;
      margin-top: 20px;
    }

    .badge-slot {
      width: 250px;
      height: 250px;
      border: 2px dashed #888;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      background-color: #000;
      color: #fff;
    }

    .badge-slot img {
      max-width: 100%;
      max-height: 100%;
    }

    #loadingIndicator {
      display: none;
      font-size: 18px;
      color: #fff;
      margin-top: 20px;
    }

    .badge-status {
      margin: 6px 0;
      font-weight: bold;
      color: #fff;
    }

    .unlocked {
      color: #0f0;
    }

    .locked {
      color: #f00;
    }

    button {
      background-color: #222;
      color: #fff;
      border: 1px solid #fff;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
    }

    button:hover {
      background-color: #444;
    }
  </style>
</head>
<body>
  <div id="loginSection">
    <h1>Connect Wallet</h1>
    <button id="loginButton">Login with MetaMask</button>
  </div>

  <div id="profileSection" style="display:none;">
    <h2>Mutant Records collection by</h2>
    <p id="walletAddress"></p>
    <button onclick="logout()">Logout</button>

    <div id="badgeOneStatus" class="badge-status"></div>
    <div id="badgeTwoStatus" class="badge-status"></div>
    <div id="badgeThreeStatus" class="badge-status"></div>
    <div id="loadingIndicator">Loading your records...</div>

    <h3>Your Records</h3>
    <div class="badge-grid" id="badgeGrid"></div>
  </div>

  <script>
    const contractA = "0xed10cd2183de930c70c812d237d5ee763a9bbc52"; // Badge 1
    const contractB = "0xdfa50db2aa335e8ccd0671ca11abce7938a3ec09"; // Badge 2 & 3

    const contractABI = [
      { "constant": true, "inputs": [{ "name": "owner", "type": "address" }], "name": "balanceOf", "outputs": [{ "name": "balance", "type": "uint256" }], "type": "function" },
      { "constant": true, "inputs": [{ "name": "tokenId", "type": "uint256" }], "name": "tokenURI", "outputs": [{ "name": "uri", "type": "string" }], "type": "function" },
      { "constant": true, "inputs": [{ "name": "tokenId", "type": "uint256" }], "name": "ownerOf", "outputs": [{ "name": "owner", "type": "address" }], "type": "function" },
      { "constant": true, "inputs": [{ "name": "owner", "type": "address" }, { "name": "index", "type": "uint256" }], "name": "tokenOfOwnerByIndex", "outputs": [{ "name": "tokenId", "type": "uint256" }], "type": "function" }
    ];

    const apechainParams = {
      chainId: "33139",
      chainName: "ApeChain",
      nativeCurrency: {
        name: "APE",
        symbol: "APE",
        decimals: 18
      },
      rpcUrls: ["https://apechain.drpc.org"],
      blockExplorerUrls: ["https://apescan.io"]
    };

    async function switchToApeChain(provider) {
      try {
        await provider.send("wallet_switchEthereumChain", [{ chainId: apechainParams.chainId }]);
      } catch (err) {
        if (err.code === 4902) {
          await provider.send("wallet_addEthereumChain", [apechainParams]);
        } else {
          console.error("Chain switch failed", err);
          alert("Failed to switch to ApeChain");
        }
      }
    }

    async function connectWallet() {
      if (!window.ethereum) return alert("Please install MetaMask!");

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      await switchToApeChain(provider);

      const signer = provider.getSigner();
      const userAddress = await signer.getAddress();
      document.getElementById("walletAddress").innerText = "Wallet: " + userAddress;

      document.getElementById("loginSection").style.display = "none";
      document.getElementById("profileSection").style.display = "block";
      document.getElementById("loadingIndicator").style.display = "block";

      let badgeURIs = [];
      let badge1 = false, badge2 = false, badge3 = false;

      const contractAInstance = new ethers.Contract(contractA, contractABI, provider);
      const contractBInstance = new ethers.Contract(contractB, contractABI, provider);

      // üîç Manually scan token IDs 0‚Äì20 for contract A (non-enumerable)
      for (let tokenId = 0; tokenId <= 69; tokenId++) {
        try {
          const owner = await contractAInstance.ownerOf(tokenId);
          if (owner.toLowerCase() === userAddress.toLowerCase()) {
            badge1 = true;
            const uri = await contractAInstance.tokenURI(tokenId);
            const resolvedUri = uri.startsWith("ipfs://") ? "https://ipfs.io/ipfs/" + uri.substring(7) : uri;
            const res = await fetch(resolvedUri);
            const metadata = await res.json();
            const image = metadata.image.startsWith("ipfs://") ? "https://ipfs.io/ipfs/" + metadata.image.substring(7) : metadata.image;
            badgeURIs.push(image);
            console.log("‚úÖ Found NFT in contractA:", tokenId);
          }
        } catch (err) {
          // ownerOf fails if token doesn't exist ‚Äî that's OK
        }
      }

      // üß† Enumerate contractB using tokenOfOwnerByIndex
      const balanceB = await contractBInstance.balanceOf(userAddress);
      for (let i = 0; i < balanceB.toNumber(); i++) {
        try {
          const tokenId = await contractBInstance.tokenOfOwnerByIndex(userAddress, i);
          const tokenNum = tokenId.toNumber();
          if (tokenNum >= 1 && tokenNum <= 420) badge2 = true;
          if (tokenNum >= 2000 && tokenNum <= 4000) badge3 = true;

          const uri = await contractBInstance.tokenURI(tokenId);
          const resolvedUri = uri.startsWith("ipfs://") ? "https://ipfs.io/ipfs/" + uri.substring(7) : uri;
          const res = await fetch(resolvedUri);
          const metadata = await res.json();
          const image = metadata.image.startsWith("ipfs://") ? "https://ipfs.io/ipfs/" + metadata.image.substring(7) : metadata.image;
          badgeURIs.push(image);
          console.log("‚úÖ Found NFT in contractB:", tokenNum);
        } catch (err) {
          console.warn("Failed token fetch from contractB", err);
        }
      }

      if (badgeURIs.length === 0) {
        document.getElementById("loadingIndicator").innerText = "‚ùå No NFTs detected ‚Äî check dev console.";
        return;
      }

      const badgeGrid = document.getElementById("badgeGrid");
      badgeGrid.innerHTML = "";
      badgeURIs.forEach(uri => {
        const slot = document.createElement("div");
        slot.className = "badge-slot";
        const img = document.createElement("img");
        img.src = uri;
        img.alt = "NFT";
        slot.appendChild(img);
        badgeGrid.appendChild(slot);
      });

      while (badgeGrid.children.length < 10) {
        const slot = document.createElement("div");
        slot.className = "badge-slot";
        slot.innerText = "Empty Record Slot";
        badgeGrid.appendChild(slot);
      }

      document.getElementById("badgeOneStatus").innerHTML = badge1
        ? "‚úÖ <span class='unlocked'>Badge 1 Unlocked (any token from ...bbc52)</span>"
        : "üîí <span class='locked'>Badge 1 Locked</span>";

      document.getElementById("badgeTwoStatus").innerHTML = badge2
        ? "‚úÖ <span class='unlocked'>Badge 2 Unlocked (ID 1‚Äì420 from ...ec09)</span>"
        : "üîí <span class='locked'>Badge 2 Locked</span>";

      document.getElementById("badgeThreeStatus").innerHTML = badge3
        ? "‚úÖ <span class='unlocked'>Badge 3 Unlocked (ID 2000‚Äì4000 from ...ec09)</span>"
        : "üîí <span class='locked'>Badge 3 Locked</span>";

      document.getElementById("loadingIndicator").style.display = "none";
    }

    function logout() {
      location.reload();
    }

    document.getElementById("loginButton").onclick = connectWallet;
  </script>
</body>
</html>



