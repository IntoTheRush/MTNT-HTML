<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mutant Records Collection</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      background: url('background.png') center center / cover no-repeat;
      background-attachment: fixed;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
    }
    .badge-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    @media (max-width: 600px) {
      .badge-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    .badge-slot {
      width: 100%;
      aspect-ratio: 1 / 1;
      border: 2px solid #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      background-color: #000;
      color: #fff;
      overflow: hidden;
    }
    .badge-slot img, .badge-slot video {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
    }
    #loadingIndicator {
      display: none;
      font-size: 18px;
      margin-top: 20px;
    }
    #progressBar {
      width: 100%;
      background-color: #333;
      margin-top: 10px;
      border: 1px solid #fff;
    }
    #progressBarFill {
      height: 20px;
      width: 0%;
      background-color: #00ffff !important;
      transition: width 0.3s;
    }
    .badge-status {
      margin: 6px 0;
      font-weight: bold;
    }
    .unlocked { color: #0f0; }
    .locked { color: #f00; }
    button, #exitButton {
      background-color: #222;
      color: #fff;
      border: 1px solid #fff;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
      text-decoration: none;
    }
    button:hover, #exitButton:hover {
      background-color: #444;
    }
  </style>
</head>
<body>
  <a href="index.html" id="exitButton">Exit</a>
  <div id="loginSection">
    <h1>Connect Wallet</h1>
    <button id="loginButton">Login with MetaMask</button>
    <p id="walletWarning" style="color: red; display: none;">MetaMask not detected. Please install MetaMask to proceed.</p>
  </div>

  <div id="profileSection" style="display:none;">
    <h2>Mutant Records collection by</h2>
    <p id="walletAddress"></p>
    <button onclick="logout()">Logout</button>

    <div id="badgeOneStatus" class="badge-status"></div>
    <div id="badgeTwoStatus" class="badge-status"></div>
    <div id="badgeThreeStatus" class="badge-status"></div>
    <div id="badgeFourStatus" class="badge-status"></div>
    <div id="loadingIndicator">Loading your records...</div>
    <div id="progressBar"><div id="progressBarFill"></div></div>

    <h3>Your Records</h3>
    <div class="badge-grid" id="badgeGrid"></div>
  </div>

  <script>
    const contractA = "0xed10cd2183de930c70c812d237d5ee763a9bbc52";
    const contractB = "0xdfa50db2aa335e8ccd0671ca11abce7938a3ec09";
    const contractOG = "0xbbe59d056e8a1ce9acc0b83574075f41d0aeca07";

    const contractABI721 = [
      { "constant": true, "inputs": [{ "name": "tokenId", "type": "uint256" }], "name": "ownerOf", "outputs": [{ "name": "owner", "type": "address" }], "type": "function" },
      { "constant": true, "inputs": [{ "name": "tokenId", "type": "uint256" }], "name": "tokenURI", "outputs": [{ "name": "uri", "type": "string" }], "type": "function" }
    ];

    const contractABI1155 = [
      { "constant": true, "inputs": [{ "name": "account", "type": "address" }, { "name": "id", "type": "uint256" }], "name": "balanceOf", "outputs": [{ "name": "", "type": "uint256" }], "type": "function" }
    ];

    const apechainParams = {
      chainId: "0x8183",
      chainName: "ApeChain",
      nativeCurrency: { name: "APE", symbol: "APE", decimals: 18 },
      rpcUrls: ["https://apechain.drpc.org"],
      blockExplorerUrls: ["https://apescan.io"]
    };

    function resolveIPFS(uri) {
      return uri.startsWith("ipfs://") ? "https://ipfs.io/ipfs/" + uri.slice(7) : uri;
    }

    function range(start, end) {
      return Array.from({ length: end - start + 1 }, (_, i) => i + start);
    }

    async function switchToApeChain(provider) {
      try {
        await provider.send("wallet_switchEthereumChain", [{ chainId: apechainParams.chainId }]);
      } catch (err) {
        if (err.code === 4902) {
          await provider.send("wallet_addEthereumChain", [apechainParams]);
        } else {
          throw err;
        }
      }
    }

    async function connectWallet() {
      if (typeof window.ethereum === 'undefined') {
        document.getElementById("walletWarning").style.display = "block";
        return;
      }

      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        await switchToApeChain(provider);

        const signer = provider.getSigner();
        const userAddress = await signer.getAddress();

        await signer.signMessage("Sign this message to confirm your wallet for Mutant Records.");
        document.getElementById("walletAddress").innerText = "Wallet: " + userAddress;

        document.getElementById("loginSection").style.display = "none";
        document.getElementById("profileSection").style.display = "block";
        document.getElementById("loadingIndicator").style.display = "block";

        const badgeGrid = document.getElementById("badgeGrid");
        badgeGrid.innerHTML = "";

        const contractAInstance = new ethers.Contract(contractA, contractABI721, provider);
        const contractBInstance = new ethers.Contract(contractB, contractABI721, provider);
        const contractOGInstance = new ethers.Contract(contractOG, contractABI1155, provider);

        let badge1 = false, badge2 = false, badge3 = false, badge4 = false;
        let hasRoyaltyPass = false;
        const badgeURIs = [];
        const seenNames = new Set();

        async function scanContract(contract, tokenIds, label) {
          for (const tokenId of tokenIds) {
            try {
              const owner = await contract.ownerOf(tokenId);
              if (owner.toLowerCase() === userAddress.toLowerCase()) {
                const uri = resolveIPFS(await contract.tokenURI(tokenId));
                const metadata = await (await fetch(uri)).json();
                const name = metadata.name;
                if (seenNames.has(name)) continue;
                seenNames.add(name);

                if (name === "NaNa The Ape, Rick Starr - $HOES Anthem") badge3 = true;
                if (name === "NaNe The Ape & Rick Starr - Let's Ape") badge2 = true;
                if (label === 'A') badge1 = true;
                if (name === "Royalty Pass") {
  hasRoyaltyPass = true;
}
if (name !== "Royalty Pass") {
  badgeURIs.push({ src: resolveIPFS(metadata.image), name });
}
              }
            } catch (e) {
              console.warn("Error with tokenId", tokenId);
            }
          }
        }

        await scanContract(contractAInstance, range(1, 69), 'A');
        await scanContract(contractBInstance, range(1, 420), 'B');
        await scanContract(contractBInstance, range(2800, 4000), 'B');

        for (let tokenId = 0; tokenId < 100; tokenId++) {
          const balance = await contractOGInstance.balanceOf(userAddress, tokenId);
          if (balance.gt(0)) {
            badge4 = true;
            break;
          }
        }

        if (badge4) {
          const ogSlot = document.createElement("div");
          ogSlot.className = "badge-slot";
          const img = document.createElement("img");
          img.src = "apestrong.jpg";
          img.alt = "OG Holder Badge";
          ogSlot.appendChild(img);
          badgeGrid.appendChild(ogSlot);
        }

        if (hasRoyaltyPass) {
          const passSlot = document.createElement("div");
          passSlot.className = "badge-slot";
          const video = document.createElement("video");
          video.src = "royaltypass.MP4";
          video.autoplay = true;
          video.loop = true;
          video.muted = true;
          video.playsInline = true;
          passSlot.appendChild(video);
          badgeGrid.appendChild(passSlot);
        }

        for (const badge of badgeURIs) {
          const slot = document.createElement("div");
          slot.className = "badge-slot";
          const img = document.createElement("img");
          img.src = badge.src;
          img.alt = badge.name;
          slot.appendChild(img);
          badgeGrid.appendChild(slot);
        }

        document.getElementById("badgeOneStatus").innerHTML = badge1 ? "âœ… <span class='unlocked'>Badge 1 Unlocked</span>" : "ðŸ”’ <span class='locked'>Badge 1 Locked</span>";
        document.getElementById("badgeTwoStatus").innerHTML = badge2 ? "âœ… <span class='unlocked'>Badge 2 Unlocked</span>" : "ðŸ”’ <span class='locked'>Badge 2 Locked</span>";
        document.getElementById("badgeThreeStatus").innerHTML = badge3 ? "âœ… <span class='unlocked'>Badge 3 Unlocked</span>" : "ðŸ”’ <span class='locked'>Badge 3 Locked</span>";
        document.getElementById("badgeFourStatus").innerHTML = badge4 ? "âœ… <span class='unlocked'>Badge 4 Unlocked</span>" : "ðŸ”’ <span class='locked'>Badge 4 Locked</span>";

        document.getElementById("loadingIndicator").style.display = "none";
      } catch (err) {
        console.error("MetaMask connection failed:", err);
        alert("Failed to connect to MetaMask. Please ensure it's installed and unlocked.");
      }
    }

    function logout() {
      location.reload();
    }

    document.getElementById("loginButton").onclick = connectWallet;
  </script>
</body>
</html>














