<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mutant Records Collection</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    body {
      background: url('background.png') center center / cover no-repeat;
      background-attachment: fixed;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
    }

    .badge-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .badge-slot {
      width: 100%;
      aspect-ratio: 1 / 1;
      border: 2px solid #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      background-color: #000;
      color: #fff;
    }

    .badge-slot img,
    .badge-slot video {
      max-width: 100%;
      max-height: 100%;
    }

    #loadingIndicator {
      font-size: 18px;
      margin-top: 20px;
    }

    #progressBar {
      width: 100%;
      background-color: #333;
      margin-top: 10px;
      border: 1px solid #fff;
    }

    #progressBarFill {
      height: 20px;
      width: 0%;
      background-color: #00ffff;
      transition: width 0.3s;
    }

    .badge-status {
      margin: 6px 0;
      font-weight: bold;
    }

    .unlocked { color: #0f0; }
    .locked { color: #f00; }

    button {
      background-color: #222;
      color: #fff;
      border: 1px solid #fff;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
    }

    button:hover {
      background-color: #444;
    }

    #exitButton {
      background-color: #222;
      color: #fff;
      border: 1px solid #fff;
      padding: 10px 16px;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 20px;
    }

    #exitButton:hover {
      background-color: #444;
    }
  </style>
</head>
<body>
  <a href="index.html" id="exitButton">Exit</a>

  <div id="loginSection">
    <h1>Collectors Book</h1>
    <button id="loginButton" onclick="connect()">Login with MetaMask</button>
  </div>

  <div id="profileSection" style="display:none;">
    <h2>Mutant Records collectibles by</h2>
    <p id="walletAddress"></p>
    <button onclick="location.reload()">Logout</button>

    <div id="badgeOneStatus" class="badge-status"></div>
    <div id="badgeTwoStatus" class="badge-status"></div>
    <div id="badgeThreeStatus" class="badge-status"></div>
    <div id="badgeFourStatus" class="badge-status"></div>
    <div id="badgeFiveStatus" class="badge-status"></div>

    <div id="loadingIndicator" style="display: none;">
      <span id="loadingText">Loading your records...</span>
    </div>
    <div id="progressBar"><div id="progressBarFill"></div></div>

    <h3>Mutant Records collectibles</h3>
    <div class="badge-grid" id="badgeGrid"></div>

    <h3>DripHeadz Music</h3>
    <div class="badge-grid" id="inkspireGrid"></div>
  </div>

  <script>
    const loadingMessages = [
      "ðŸ§  Scanning ApeChain...",
      "ðŸŽ· Looking for music in the blockchain...",
      "ðŸ™ Checking the church...",
      "ðŸ¦ Ape monks decoding grooves...",
      "ðŸŽ¶ Tuning vinyl in hyperspace...",
      "ðŸŒ Spinning bananas into beats...",
      "ðŸ”Š Listening for lost records...",
      "ðŸ§¬ Synthesizing rare sounds..."
    ];
    let messageIndex = 0;
    let intervalId;
    const progressBarFill = document.getElementById("progressBarFill");

    function startLoadingAnimation() {
      document.getElementById("loadingIndicator").style.display = "block";
      messageIndex = 0;
      intervalId = setInterval(() => {
        document.getElementById("loadingText").innerText = loadingMessages[messageIndex % loadingMessages.length];
        messageIndex++;
      }, 2000);
    }

    function updateProgressBar(processed, total) {
      const percent = Math.round((processed / total) * 100);
      progressBarFill.style.width = percent + "%";
    }

    function range(start, end) {
      return Array.from({ length: end - start + 1 }, (_, i) => i + start);
    }

    function resolveIPFS(uri) {
      return uri.startsWith("ipfs://") ? "https://ipfs.io/ipfs/" + uri.slice(7) : uri;
    }

    async function switchToApeChain() {
      try {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: "33139" }] // 33139
        });
      } catch (err) {
        if (err.code === 4902) {
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [{
              chainId: "33139",
              chainName: "ApeChain",
              nativeCurrency: { name: "APE", symbol: "APE", decimals: 18 },
              rpcUrls: ["https://apechain.drpc.org"],
              blockExplorerUrls: ["https://apescan.io"]
            }]
          });
        } else {
          alert("Could not switch to ApeChain");
        }
      }
    }

    async function connect() {
      if (!window.ethereum) return alert("Please install MetaMask!");

      const web3 = new Web3(window.ethereum);
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      await switchToApeChain();

      const accounts = await web3.eth.getAccounts();
      const userAddress = accounts[0];

      try {
        await web3.eth.personal.sign("Sign this message to confirm your wallet for Mutant Records.", userAddress);
      } catch {
        alert("Signature declined.");
        return;
      }

      document.getElementById("walletAddress").innerText = "Wallet: " + userAddress;
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("profileSection").style.display = "block";

      startLoadingAnimation();

      const contractA = "0xed10cd2183de930c70c812d237d5ee763a9bbc52";
      const contractB = "0xdfa50db2aa335e8ccd0671ca11abce7938a3ec09";
      const contractOG = "0xbbe59d056e8a1ce9acc0b83574075f41d0aeca07";
      const inkspireContract = "0x00d48b06b39f76e45966ff11b318059620ac470b";

      const abi721 = [
        { constant: true, inputs: [{ name: "tokenId", type: "uint256" }], name: "ownerOf", outputs: [{ name: "owner", type: "address" }], type: "function" },
        { constant: true, inputs: [{ name: "tokenId", type: "uint256" }], name: "tokenURI", outputs: [{ name: "uri", type: "string" }], type: "function" }
      ];
      const abi1155 = [
        { constant: true, inputs: [{ name: "account", type: "address" }, { name: "id", type: "uint256" }], name: "balanceOf", outputs: [{ name: "", type: "uint256" }], type: "function" }
      ];

      const badgeGrid = document.getElementById("badgeGrid");
      const inkspireGrid = document.getElementById("inkspireGrid");
      badgeGrid.innerHTML = "";
      inkspireGrid.innerHTML = "";

      const contractAInst = new web3.eth.Contract(abi721, contractA);
      const contractBInst = new web3.eth.Contract(abi721, contractB);
      const contractOGInst = new web3.eth.Contract(abi1155, contractOG);
      const inkspireInst = new web3.eth.Contract(abi721, inkspireContract);

      let badge1 = false, badge2 = false, badge3 = false, badge5 = false;
      const seenNames = new Set();
      const badgeURIs = [], inkspireURIs = [];

      async function scanContract(contract, tokenIds, label) {
        let processed = 0;
        for (let id of tokenIds) {
          try {
            const owner = await contract.methods.ownerOf(id).call();
            if (owner.toLowerCase() === userAddress.toLowerCase()) {
              const uri = resolveIPFS(await contract.methods.tokenURI(id).call());
              const metadata = await fetch(uri).then(res => res.json());
              if (seenNames.has(metadata.name)) continue;
              seenNames.add(metadata.name);
              const image = resolveIPFS(metadata.image);
              (label === 'INKSPIRE' ? inkspireURIs : badgeURIs).push({ src: image, name: metadata.name });
              if (metadata.name.includes("Let's Ape")) badge2 = true;
              if (metadata.name.includes("$HOES Anthem")) badge3 = true;
              if (!badge1 && label === 'A') badge1 = true;
            }
          } catch {}
          processed++;
          updateProgressBar(processed, tokenIds.length);
        }
      }

      async function checkOGBadge() {
        for (let i = 0; i < 100; i++) {
          try {
            const balance = await contractOGInst.methods.balanceOf(userAddress, i).call();
            if (balance > 0) return true;
          } catch {}
        }
        return false;
      }

      await scanContract(contractAInst, range(1, 69), 'A');
      await scanContract(contractBInst, range(1, 420), 'B');
      await scanContract(contractBInst, range(2800, 4000), 'B');
      await scanContract(inkspireInst, range(1, 100), 'INKSPIRE');

      badge5 = inkspireURIs.length > 0;
      const ogBadge = await checkOGBadge();

      document.getElementById("badgeOneStatus").innerHTML = badge1 ? "âœ… <span class='unlocked'>Royalty Music Pass Unlock</span>" : "ðŸ”’ <span class='locked'>Badge 1 Locked</span>";
      document.getElementById("badgeTwoStatus").innerHTML = badge2 ? "âœ… <span class='unlocked'>Badge 2 Unlocked (\"Let's Ape\")</span>" : "ðŸ”’ <span class='locked'>Badge 2 Locked</span>";
      document.getElementById("badgeThreeStatus").innerHTML = badge3 ? "âœ… <span class='unlocked'>Badge 3 Unlocked (\"$HOES Anthem\")</span>" : "ðŸ”’ <span class='locked'>Badge 3 Locked</span>";
      document.getElementById("badgeFourStatus").innerHTML = ogBadge ? "âœ… <span class='unlocked'>OG Supporter</span>" : "ðŸ”’ <span class='locked'>Badge 4 Locked</span>";
      document.getElementById("badgeFiveStatus").innerHTML = badge5 ? "âœ… <span class='unlocked'>DripHeadz</span>" : "ðŸ”’ <span class='locked'>Dripheadz NFT Not Found</span>";

      if (badge1) {
        const video = document.createElement("video");
        video.src = "royaltypass.MP4";
        video.autoplay = video.loop = video.muted = true;
        video.playsInline = true;
        const slot = document.createElement("div");
        slot.className = "badge-slot";
        slot.appendChild(video);
        badgeGrid.appendChild(slot);
      }

      badgeURIs.forEach(item => {
        const slot = document.createElement("div");
        slot.className = "badge-slot";
        const img = document.createElement("img");
        img.src = item.src;
        img.alt = item.name;
        slot.appendChild(img);
        badgeGrid.appendChild(slot);
      });

      if (ogBadge) {
        const slot = document.createElement("div");
        slot.className = "badge-slot";
        const img = document.createElement("img");
        img.src = "apestrong.jpg";
        img.alt = "OG Badge";
        slot.appendChild(img);
        badgeGrid.appendChild(slot);
      }

      const totalSlots = 6;
      const current = badgeGrid.querySelectorAll(".badge-slot").length;
      for (let i = current; i < totalSlots; i++) {
        const slot = document.createElement("div");
        slot.className = "badge-slot";
        slot.innerText = "Empty Record Slot";
        badgeGrid.appendChild(slot);
      }

      inkspireURIs.forEach(item => {
        const slot = document.createElement("div");
        slot.className = "badge-slot";
        const img = document.createElement("img");
        img.src = item.src;
        img.alt = item.name;
        slot.appendChild(img);
        inkspireGrid.appendChild(slot);
      });

      clearInterval(intervalId);
      document.getElementById("loadingIndicator").style.display = "none";
    }
  </script>
</body>
</html>


