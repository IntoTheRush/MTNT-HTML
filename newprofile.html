<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mutant Records Collection</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <style>
    body {
      background: url('background.png') center center / cover no-repeat;
      background-attachment: fixed;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
    }
    header {
      background: url('background.png') center center / cover no-repeat;
      height: 200px;
      margin-bottom: 20px;
    }
    button {
      background-color: #222;
      color: #fff;
      border: 1px solid #fff;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
      margin: 6px;
    }
    button:hover {
      background-color: #444;
    }
  </style>
</head>
<body>
  <div id="loginSection">
    <h1>Collectors Book</h1>
    <button id="loginMetaMask">Login with MetaMask</button>
    <button id="loginWalletConnect">Login with WalletConnect</button>
  </div>

  <div id="profileSection" style="display:none;">
    <h2>Mutant Records collectibles by</h2>
    <p id="walletAddress"></p>
    <button onclick="logout()">Logout</button>

    <div id="badgeStatusContainer"></div>
    <div class="badge-grid" id="badgeGrid"></div>
    <div class="badge-grid" id="inkspireGrid"></div>
  </div>

  <script>
    const apechainParams = {
      chainId: "33139", // 33139 in hex
      chainName: "ApeChain",
      nativeCurrency: { name: "APE", symbol: "APE", decimals: 18 },
      rpcUrls: ["https://apechain.drpc.org"],
      blockExplorerUrls: ["https://apescan.io"]
    };

    const contractA = "0xed10cd2183de930c70c812d237d5ee763a9bbc52";
    const contractB = "0xdfa50db2aa335e8ccd0671ca11abce7938a3ec09";
    const contractOG = "0xbbe59d056e8a1ce9acc0b83574075f41d0aeca07";
    const inkspireContractAddress = "0x00d48b06b39f76e45966ff11b318059620ac470b";

    const contractABI721 = [
      { "constant": true, "inputs": [{ "name": "tokenId", "type": "uint256" }], "name": "ownerOf", "outputs": [{ "name": "owner", "type": "address" }], "type": "function" },
      { "constant": true, "inputs": [{ "name": "tokenId", "type": "uint256" }], "name": "tokenURI", "outputs": [{ "name": "uri", "type": "string" }], "type": "function" }
    ];

    const contractABI1155 = [
      { "constant": true, "inputs": [{ "name": "account", "type": "address" }, { "name": "id", "type": "uint256" }], "name": "balanceOf", "outputs": [{ "name": "", "type": "uint256" }], "type": "function" }
    ];

    function resolveIPFS(uri) {
      if (!uri.startsWith("ipfs://")) return uri;
      return "https://ipfs.io/ipfs/" + uri.slice(7);
    }

    function range(start, end) {
      return Array.from({ length: end - start + 1 }, (_, i) => i + start);
    }

    async function switchToApeChain(provider) {
      try {
        await provider.send("wallet_switchEthereumChain", [{ chainId: apechainParams.chainId }]);
      } catch (err) {
        if (err.code === 4902) {
          await provider.send("wallet_addEthereumChain", [apechainParams]);
        } else {
          alert("Failed to switch to ApeChain");
          throw err;
        }
      }
    }

    async function connectMetaMask() {
      if (!window.ethereum) return alert("MetaMask is not installed!");
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      await switchToApeChain(provider);
      const signer = provider.getSigner();
      await onWalletConnected(provider, signer);
    }

    const walletConnectProvider = new WalletConnectProvider.default({
      rpc: { 33139: "https://apechain.drpc.org" },
      chainId: 33139
    });

    async function connectWalletConnect() {
      await walletConnectProvider.enable();
      const provider = new ethers.providers.Web3Provider(walletConnectProvider);
      const signer = provider.getSigner();
      await onWalletConnected(provider, signer);
    }

    async function onWalletConnected(provider, signer) {
      const userAddress = await signer.getAddress();
      await signer.signMessage("Sign this message to confirm your wallet for Mutant Records.");
      document.getElementById("walletAddress").innerText = "Wallet: " + userAddress;
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("profileSection").style.display = "block";

      await loadBadges(provider, userAddress);
    }

    async function loadBadges(provider, userAddress) {
      const badgeGrid = document.getElementById("badgeGrid");
      const inkspireGrid = document.getElementById("inkspireGrid");
      badgeGrid.innerHTML = "";
      inkspireGrid.innerHTML = "";

      const contractAInstance = new ethers.Contract(contractA, contractABI721, provider);
      const contractBInstance = new ethers.Contract(contractB, contractABI721, provider);
      const contractOGInstance = new ethers.Contract(contractOG, contractABI1155, provider);
      const inkspireInstance = new ethers.Contract(inkspireContractAddress, contractABI721, provider);

      let badge1 = false, badge2 = false, badge3 = false, badge5 = false;
      const seenNames = new Set();
      const badgeURIs = [], inkspireURIs = [];

      async function scanContract(contract, tokenIds, label) {
        for (let tokenId of tokenIds) {
          try {
            const owner = await contract.ownerOf(tokenId);
            if (owner.toLowerCase() === userAddress.toLowerCase()) {
              const uri = resolveIPFS(await contract.tokenURI(tokenId));
              const metadata = await fetch(uri).then(r => r.json());
              if (seenNames.has(metadata.name)) continue;
              seenNames.add(metadata.name);
              const image = resolveIPFS(metadata.image);
              const target = label === 'INKSPIRE' ? inkspireURIs : badgeURIs;
              target.push({ src: image, name: metadata.name });
              if (metadata.name.includes("Let's Ape")) badge2 = true;
              if (metadata.name.includes("$HOES Anthem")) badge3 = true;
              if (!badge1 && label === 'A') badge1 = true;
            }
          } catch {}
        }
      }

      await scanContract(contractAInstance, range(1, 69), 'A');
      await scanContract(contractBInstance, range(1, 420), 'B');
      await scanContract(contractBInstance, range(2800, 4000), 'B');
      await scanContract(inkspireInstance, range(1, 100), 'INKSPIRE');
      if (inkspireURIs.length > 0) badge5 = true;

      const ogBadgeUnlocked = await checkOGBadge(userAddress, contractOGInstance);

      const statusEl = document.getElementById("badgeStatusContainer");
      statusEl.innerHTML = `
        <div>${badge1 ? 'âœ… Royalty Pass' : 'ðŸ”’ Badge 1 Locked'}</div>
        <div>${badge2 ? 'âœ… Badge 2: Let\'s Ape' : 'ðŸ”’ Badge 2 Locked'}</div>
        <div>${badge3 ? 'âœ… Badge 3: $HOES Anthem' : 'ðŸ”’ Badge 3 Locked'}</div>
        <div>${ogBadgeUnlocked ? 'âœ… OG Supporter' : 'ðŸ”’ Badge 4 Locked'}</div>
        <div>${badge5 ? 'âœ… Dripheadz Found' : 'ðŸ”’ Badge 5 Locked'}</div>
      `;

      for (const item of badgeURIs) {
        const img = document.createElement("img");
        img.src = item.src;
        img.alt = item.name;
        img.title = item.name;
        const div = document.createElement("div");
        div.className = "badge-slot";
        div.appendChild(img);
        badgeGrid.appendChild(div);
      }

      for (const item of inkspireURIs) {
        const img = document.createElement("img");
        img.src = item.src;
        img.alt = item.name;
        img.title = item.name;
        const div = document.createElement("div");
        div.className = "badge-slot";
        div.appendChild(img);
        inkspireGrid.appendChild(div);
      }
    }

    async function checkOGBadge(userAddress, contractOGInstance) {
      for (let tokenId = 0; tokenId < 100; tokenId++) {
        const balance = await contractOGInstance.balanceOf(userAddress, tokenId);
        if (balance.gt(0)) return true;
      }
      return false;
    }

    function logout() {
      if (walletConnectProvider && walletConnectProvider.disconnect) {
        walletConnectProvider.disconnect();
      }
      location.reload();
    }

    document.getElementById("loginMetaMask").addEventListener("click", connectMetaMask);
    document.getElementById("loginWalletConnect").addEventListener("click", connectWalletConnect);
  </script>
</body>
</html>





